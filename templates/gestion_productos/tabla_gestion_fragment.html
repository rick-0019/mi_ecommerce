{% for p in productos_gestion %}
<tr class="animate__animated animate__fadeIn">
    <td>
        <div class="d-flex align-items-center">
            {% if p.imagen_principal %}
                <img src="{{ p.imagen_principal.url }}" alt="{{ p.nombre }}" class="rounded me-2" style="width: 40px; height: 40px; object-fit: cover;">
            {% endif %}
            <div>
                <div class="fw-bold">{{ p.nombre }}</div>
                <small class="text-muted">SKU: {{ p.sku }}</small>
            </div>
        </div>
    </td>
    <td>{{ p.categoria.nombre }}</td>
    <td class="text-center">
        <div class="d-flex align-items-center justify-content-center gap-2">
            {% if p.stock_local != None %}
                <span class="badge {% if p.stock_local <= 5 %}bg-danger{% elif p.stock_local <= 20 %}bg-warning text-dark{% else %}bg-success{% endif %} rounded-pill px-3">
                    {{ p.stock_local }}
                </span>
            {% else %}
                <span class="text-muted small">Sin stock cargado</span>
            {% endif %}
            
            <button class="btn btn-sm btn-outline-info rounded-circle p-1 leading-none shadow-sm" 
                    style="width: 24px; height: 24px;" 
                    onclick="verStockGlobal('{{ p.id }}')" 
                    title="Ver stock en otras sucursales">
                <i class="bi bi-info-circle" style="font-size: 0.8rem;"></i>
            </button>
        </div>
    </td>
    <td class="fw-bold">$ {{ p.precio_actual|floatformat:2 }}</td>
    <td class="text-center">
        <div class="d-flex justify-content-center gap-2">
            <a href="{% url 'gestion_productos:editar' p.id %}" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-pencil-square"></i>
            </a>
            <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#modalEliminar{{ p.id }}">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    </td>
</tr>

<!-- Modal Eliminar para cada producto en el fragmento -->
<div class="modal fade" id="modalEliminar{{ p.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">Eliminar Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                ¿Estás seguro de que deseas eliminar <strong>{{ p.nombre }}</strong>? Esta acción no se puede deshacer.
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                <form action="{% url 'gestion_productos:eliminar' p.id %}" method="post" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger px-4">Eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% empty %}
<tr>
    <td colspan="4" class="text-center text-muted py-4">No se encontraron productos.</td>
</tr>
{% endfor %}
